# Развертывание на хостинге

Развертывание производится в папке `crm.cmit22.ru/cgi`.

Для работы на хостинге нужно создать виртуальное окружение Python (`venv` -- папка с виртуальным окружением):

```
virtualenv -p python3 venv
```

## Обновление версии на хостинге

Есть 2 конфигурации сайта ([config.py](https://github.com/qwert2603/crmit/blob/master/config.py)):

* **DevConfig** используется для разработки и тестирования
* **ProdConfig** используется на хостинге

Перед обновлением сайта на хостинге **нужно сохранить** параметры `SECRET_KEY` и `ACCESS_TOKEN_SALT` из `ProdConfig`, так как они будут стерты при обновлении версии.

Теперь удаляем старую версию:

```
rm -rf app/ comms.txt config.py migrations/ __pycache__/ README.md requiments.txt
rm -rf app_holder.py credentials.txt make_crmit_dump.py tests/
rm -rf start_dev.py start_prod_default.py start_prod_wsgi.py
```

Распаковываем новую версию (архив.tar.gz можно скачать в разделе [releases](https://github.com/qwert2603/crmit/releases)):

```
tar -xvf crmit_0_8.tar.gz
```

Указываем параметры `SECRET_KEY` и `ACCESS_TOKEN_SALT` в `ProdConfig`, которые были сохранены ранее. Если они не были сохранены, потому что сайт развертывается впервые, или по другой причине, то нужно указать в этих параметрах секретные ключи. При работе сайта они используются в процессе авторизации и проверки авторизованного пользователя, поэтому они должны быть надежными и не должны меняться при обновлении сайта (для этого они и сохранялись в процессе обновления сайта). При изменении секретных ключей всем пользователям потребуется авторизовываться заново на сайте и в мобильном приложении.

Пример секретных ключей при развертывании сайта впервые:

```
class ProdConfig(Config):
    SECRET_KEY = 'something_private'
    ...
    ACCESS_TOKEN_SALT = 'something_private'.encode('utf-8')
    ...
```


Теперь нужно изменить конфигурацию по умолчанию на `ProdConfig`. Для этого в конце файла ([config.py](https://github.com/qwert2603/crmit/blob/master/config.py)) нужно указать `'default': ProdConfig`:

```
config = {
    'dev': DevConfig,
    'prod': ProdConfig,

    'default': ProdConfig
}
```

Если новая версия содержит изменения в схеме БД, то нужно обновить схему БД на хостинге.

Если новая версия содержит новые зависимости, то нужно установить их на хостинге.

## Установка зависимостей

После этого нужно установить требуемые зависимости:

```
venv/bin/pip3 install -r requiments.txt
```

Также может потребоваться установить зависимости для MySQL:

```
venv/bin/pip3 install mysql-connector-python
venv/bin/pip3 install mysql-python
```

## Настройка переадресации

Для переадресации запросов в Flask-приложение нужно создать файл `crm.cmit22.ru/docs/.htaccess`. Содержимое файла находится [здесь](https://github.com/qwert2603/crmit/blob/master/.htaccess).

## Создание или обновление схемы БД

Обновляем схему БД до последней миграции (миграции БД находятся в [папке](https://github.com/qwert2603/crmit/tree/master/migrations/versions)). При выполнении следующей команды на хостинге создается требуемая схема БД с учетом всех миграций:

```
venv/bin/python ~/.local/bin/flask db upgrade
```

## Создание базовых сущностей в БД

Запускаем python в контексте Flask-приложения 

```
venv/bin/python ~/.local/bin/flask shell
```

Создаем руководителя, преподавателя, ученика, разработчика и бота:

```
from app.init_model import create_stub_models
create_stub_models()
```

# Системные роли

Кроме системных ролей руководителя, преподавателя и ученика в CRM ЦМИТ также есть роли разработчика и бота.

## Системная роль "разработчик"

Эта роль предназначена для контроля за корректностью работы системы.

Разработчик имеет те же права в системе, что и руководитель.

Разработчик не может отправлять или получать сообщения. Также разработчик не может отправлять уведомления.

Разработчик может просматривать списки разработчиков и ботов, а также создавать новых разработчиков и ботов.

Разработчику доступны страницы сайта, позволяющие проверить целостность базы данных. Не все ограничения принятые в системе могут быть описаны средствами БД. К ним относятся:

- проверка того, что месяц платежа не выходит за рамки нахождения ученика в группе
- проверка того, что ученик посещает занятия в только тех группах, в которых состоит
- проверка того, что занятие не выходит за рамки функционирования группы
- проверка того, что каждая сущность "Преподаватель" ссылается на сущность "Системный пользователь" с ролью "преподаватель"

Страницы сайта, отвечающие за проверку целостности базы данных, позволяют проверить целостность этих и многих других ограничений в автоматическом режиме.

Разработчик может видеть количество посещений каждой из страниц сайта.

Все дополнительные страницы сайта, доступные разработчику, находятся в раздеде ["еще"](http://crm.cmit22.ru/anth)

В целях предосторожности для разработчика можно включить режим READ_ONLY, при котором действия разработчика не будут сохраняться в системе. При включении этого режима после каждого запроса от разработчика будет выполняться команда `db.session.rollback()`, отменяющая все изменения в БД, сделанные во время обработки запроса. Исключение составляют запросы, отвечающие за авторизацию в системе, смену пароля и выход из системы.

Для включения режима READ_ONLY для разработчика нужно указать параметр `DEVELOPER_READ_ONLY = True` в файле конфигурации [config.py](https://github.com/qwert2603/crmit/blob/master/config.py).

## Системная роль "бот"

Эта роль предназначена для выполения автоматических операций. Например, создание дампа.

Бот не может авторизовываться на сайте или в мобильном приложении.

Бот имеет доступ только к тем страницам на сайте, которые отмечены декоратором `@check_bot_access_token_with_logins`.
В параметре этого декоратора указывается список логинов ботов, которые имеют доступ к указанной странице.

По задумке, в системе присутствует только 1 бот с логином `dump_creator`, который делает дампы по расписанию.
Соответсвенно, есть только 1 метод с декоратором `@check_bot_access_token_with_logins`.
Это метод `dump` в [REST-API](https://github.com/qwert2603/crmit/blob/master/app/api_1_1_0/rests.py#L364).

# Создание дампа

Дамп создается с помощью скрипта [make_crmit_dump.py](https://github.com/qwert2603/crmit/blob/master/make_crmit_dump.py).

Необходимые параметры для создания дампа находятся в файле
[credentials.txt](https://github.com/qwert2603/crmit/blob/master/credentials.txt).

Список email получателей дампа указывается в переменной `mail_receivers` в скрипте `make_crmit_dump.py`.

Для получения `access_token` бота нужно выполнить REST-запрос авторизации, указав правильный пароль бота:

```
POST http://crm.cmit22.ru/api/v1.1.0/login
{
  "login": "dump_creator",
  "password": "the_password_of_bot",
  "device": "pc",
  "appVersion": "-1/12"
}
```

Для автоматического создания дапма по расписанию нужно настроить cron, указав путь к скрипту:
```
0 * * * * python3 /path/to/dir/make_crmit_dump.py
```
